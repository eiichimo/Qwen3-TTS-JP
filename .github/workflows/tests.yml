name: Tests

on:
  pull_request:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:

jobs:
  changes:
    name: Detect Change Scope
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    outputs:
      run_fast_tests: ${{ steps.scope.outputs.run_fast_tests }}
    steps:
      - name: Decide whether fast tests are required
        id: scope
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName !== 'pull_request') {
              core.setOutput('run_fast_tests', 'true');
              return;
            }
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });
            const docOnly = files.every(({ filename }) =>
              filename.startsWith('docs/') ||
              filename === 'README.md' ||
              filename === 'CONTRIBUTING.md' ||
              filename === 'AGENTS.md'
            );
            core.setOutput('run_fast_tests', docOnly ? 'false' : 'true');

  test-fast:
    name: Test (fast)
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - if: needs.changes.outputs.run_fast_tests == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - if: needs.changes.outputs.run_fast_tests == 'true'
        shell: bash
        run: |
          if [[ -d tests ]]; then
            python -m unittest discover -s tests -v
          else
            echo "No tests/ directory yet; fast tests skipped."
          fi
      - if: needs.changes.outputs.run_fast_tests != 'true'
        run: echo "docs-only pull request detected; fast tests skipped."

  test-full:
    name: Test (full)
    if: github.event_name != 'pull_request' || github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - shell: bash
        run: |
          if [[ -d tests ]]; then
            python -m unittest discover -s tests -v
          else
            echo "No tests/ directory yet; full tests skipped."
          fi
